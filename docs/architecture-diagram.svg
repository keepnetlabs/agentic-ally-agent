<svg viewBox="0 0 2700 1400" xmlns="http://www.w3.org/2000/svg">
  <!-- Define styles (Original Palette) -->
  <defs>
    <style>
      .box { fill: #f0f4f8; stroke: #2c3e50; stroke-width: 2; }
      .box-header { fill: #34495e; }
      .box-header-ml { fill: #3498db; }       /* Blue */
      .box-header-phishing { fill: #e74c3c; } /* Red */
      .box-header-userinfo { fill: #27ae60; } /* Green */
      .box-header-policy { fill: #8e44ad; }   /* Purple */
      .box-header-auto { fill: #d35400; }     /* Orange */
      .box-header-worker { fill: #f39c12; }   /* Yellow */
      .box-header-smishing { fill: #16a085; } /* Teal */
      .box-header-emailir { fill: #2980b9; }  /* Dark Blue */
      .box-header-vishing { fill: #c0392b; }  /* Dark Red */

      .workflow-box { fill: #ffffff; stroke-width: 2; }
      .workflow-box-ml { stroke: #3498db; }
      .workflow-box-phishing { stroke: #e74c3c; }
      .workflow-box-userinfo { stroke: #27ae60; }
      .workflow-box-policy { stroke: #8e44ad; }
      .workflow-box-worker { fill: #fef9e7; stroke: #f39c12; }

      .text-header { fill: white; font-size: 14px; font-weight: bold; font-family: sans-serif; }
      .text-normal { fill: #2c3e50; font-size: 12px; font-family: sans-serif; }
      .text-small { fill: #7f8c8d; font-size: 10px; font-family: sans-serif; }
      
      .arrow { stroke: #34495e; stroke-width: 2; fill: none; marker-end: url(#arrowhead); stroke-linecap: round; stroke-linejoin: round; }
      .arrow-no-marker { stroke: #34495e; stroke-width: 2; fill: none; stroke-linecap: round; stroke-linejoin: round; }
      .arrow-colored { stroke-width: 2; fill: none; stroke-linecap: round; stroke-linejoin: round; }
      .arrow-label { fill: #34495e; font-size: 11px; font-weight: bold; font-family: sans-serif; }
    </style>
    
    <!-- Markers -->
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><polygon points="0 0, 10 3, 0 6" fill="#34495e" /></marker>
    <marker id="arrowhead-ml" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><polygon points="0 0, 10 3, 0 6" fill="#3498db" /></marker>
    <marker id="arrowhead-phishing" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><polygon points="0 0, 10 3, 0 6" fill="#e74c3c" /></marker>
    <marker id="arrowhead-userinfo" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><polygon points="0 0, 10 3, 0 6" fill="#27ae60" /></marker>
    <marker id="arrowhead-policy" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><polygon points="0 0, 10 3, 0 6" fill="#8e44ad" /></marker>
    <marker id="arrowhead-worker" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><polygon points="0 0, 10 3, 0 6" fill="#f39c12" /></marker>
    <marker id="arrowhead-smishing" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><polygon points="0 0, 10 3, 0 6" fill="#16a085" /></marker>
    <marker id="arrowhead-emailir" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><polygon points="0 0, 10 3, 0 6" fill="#2980b9" /></marker>
    <marker id="arrowhead-vishing" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><polygon points="0 0, 10 3, 0 6" fill="#c0392b" /></marker>
  </defs>

  <!-- Title -->
  <text x="1350" y="30" font-size="28" font-weight="bold" text-anchor="middle" fill="#2c3e50" font-family="sans-serif">
    Agentic Ally - Complete Platform Architecture
  </text>

  <!-- ============================================== -->
  <!-- 1. INPUT LAYER (Triple Trigger) -->
  <!-- ============================================== -->
  
  <!-- Reactive Box -->
  <rect class="box" x="50" y="50" width="380" height="60" rx="5"/>
  <rect class="box-header" x="50" y="50" width="380" height="25" rx="5"/>
  <text class="text-header" x="240" y="67" text-anchor="middle">Reactive: HTTP POST /chat</text>
  <text class="text-normal" x="70" y="85">â€¢ User Prompt (String)</text>
  <text class="text-normal" x="70" y="100">â€¢ Context (UserId, Dept)</text>

  <!-- Proactive Box -->
  <rect class="box" x="480" y="50" width="380" height="60" rx="5"/>
  <rect class="box-header-auto" x="480" y="50" width="380" height="25" rx="5"/>
  <text class="text-header" x="670" y="67" text-anchor="middle">Proactive: Autonomous Loop</text>
  <text class="text-normal" x="500" y="85">â€¢ Cron Schedule (Daily)</text>
  <text class="text-normal" x="500" y="100">â€¢ Risk-based Trigger</text>

  <!-- Public API Endpoints Box (Right column - separate flow) -->
  <rect class="box" x="2050" y="50" width="550" height="60" rx="5"/>
  <rect class="box-header" x="2050" y="50" width="550" height="25" rx="5"/>
  <text class="text-header" x="2325" y="67" text-anchor="middle">Public API Endpoints (Direct)</text>
  <text class="text-normal" x="2070" y="85">/smishing/chat | /vishing/prompt | /vishing/conversations/summary | /email-ir/analyze</text>
  <text class="text-small" x="2070" y="100">â€¢ Bypass /chat â†’ Direct to agents below</text>

  <!-- Converging Arrows to Middleware (Y-shape, single arrowhead) -->
  <path class="arrow-no-marker" d="M 240 110 L 650 110"/> <!-- Reactive branch -->
  <path class="arrow-no-marker" d="M 670 110 L 650 110"/> <!-- Proactive branch -->
  <path class="arrow" d="M 650 110 L 650 145"/> <!-- Down to Middleware -->

  <!-- ============================================== -->
  <!-- 2. MIDDLEWARE & ORCHESTRATOR -->
  <!-- ============================================== -->
  
  <!-- Middleware Layer (main flow only) -->
  <rect class="box" x="300" y="145" width="700" height="60" rx="5"/>
  <rect class="box-header" x="300" y="145" width="700" height="25" rx="5"/>
  <text class="text-header" x="650" y="162" text-anchor="middle">Middleware Layer (Request Context)</text>
  <text class="text-normal" x="320" y="185">âœ“ AsyncLocalStorage | âœ“ Auth Token | âœ“ Rate Limiting</text>

  <path class="arrow" d="M 650 205 L 650 230"/>

  <!-- Orchestrator -->
  <rect class="box" x="300" y="230" width="700" height="60" rx="5"/>
  <rect fill="#9b59b6" x="300" y="230" width="700" height="25" rx="5"/>
  <text class="text-header" x="650" y="247" text-anchor="middle">Orchestrator Agent (The Router)</text>
  <text class="text-normal" x="350" y="270">Analyzes Intent &amp; History â†’ Routes to 7 Specialist Agents</text>

  <!-- Routing Arrows to Main Agents (fan out from center) -->
  <path class="arrow-colored" stroke="#3498db" marker-end="url(#arrowhead-ml)" d="M 650 290 L 250 340"/>     <!-- ML -->
  <path class="arrow-colored" stroke="#e74c3c" marker-end="url(#arrowhead-phishing)" d="M 650 290 L 750 340"/> <!-- Phishing -->
  <path class="arrow-colored" stroke="#8e44ad" marker-end="url(#arrowhead-policy)" d="M 650 290 L 1250 340"/> <!-- Policy -->
  <path class="arrow-colored" stroke="#27ae60" marker-end="url(#arrowhead-userinfo)" d="M 650 290 L 1750 340"/> <!-- UserInfo -->

  <!-- Labels -->
  <text x="250" y="325" class="arrow-label" fill="#3498db">Microlearning</text>
  <text x="650" y="325" class="arrow-label" fill="#e74c3c">Phishing</text>
  <text x="1000" y="325" class="arrow-label" fill="#8e44ad">Policy</text>
  <text x="1550" y="325" class="arrow-label" fill="#27ae60">User Info</text>


  <!-- ============================================== -->
  <!-- 3. AGENTS LAYER (Columns) -->
  <!-- ============================================== -->

  <!-- A. MICROLEARNING (Left) -->
  <rect class="box" x="30" y="340" width="440" height="340" rx="5"/>
  <rect class="box-header-ml" x="30" y="340" width="440" height="30" rx="5"/>
  <text class="text-header" x="250" y="360" text-anchor="middle">Microlearning Agent</text>
  <text fill="#3498db" font-weight="bold" x="80" y="385" font-size="10">(4-State Machine | Gamification | Adaptive Learning)</text>

  <!-- Create Workflow -->
  <rect class="workflow-box workflow-box-ml" x="50" y="445" width="190" height="150" rx="3"/>
  <rect fill="#3498db" x="50" y="445" width="190" height="20" rx="3"/>
  <text class="text-header" x="145" y="460" text-anchor="middle" font-size="10">CREATE WORKFLOW</text>
  <text class="text-normal" x="60" y="480" font-size="9">1. Analyze (Lang, Topic)</text>
  <text class="text-normal" x="60" y="495" font-size="9">2. Generate Structure</text>
  <text class="text-normal" x="60" y="510" font-size="9">3. Video Search (D1)</text>
  <text class="text-normal" x="60" y="525" font-size="9">4. Feature Generation</text>
  <text class="text-normal" x="60" y="540" font-size="9">5. Validate (Zod)</text>

  <!-- Add Lang Workflow -->
  <rect class="workflow-box workflow-box-ml" x="260" y="445" width="190" height="150" rx="3"/>
  <rect fill="#3498db" x="260" y="445" width="190" height="20" rx="3"/>
  <text class="text-header" x="355" y="460" text-anchor="middle" font-size="10">ADD-LANG WORKFLOW</text>
  <text class="text-normal" x="270" y="480" font-size="9">1. Load Master (KV)</text>
  <text class="text-normal" x="270" y="495" font-size="9">2. Localize (Parallel)</text>
  <text class="text-normal" x="270" y="510" font-size="9">3. Retry Strategy</text>

  <text fill="#9b59b6" font-size="9" x="50" y="660">ðŸ”— OpenAI | Workers AI | D1 Vector DB</text>

  
  <!-- B. PHISHING (Mid-Left) -->
  <rect class="box" x="530" y="340" width="440" height="340" rx="5"/>
  <rect class="box-header-phishing" x="530" y="340" width="440" height="30" rx="5"/>
  <text class="text-header" x="750" y="360" text-anchor="middle">Phishing Email Agent</text>
  <text fill="#e74c3c" font-weight="bold" x="580" y="385" font-size="10">(Cialdini | Simulation | Quishing Support)</text>

  <rect class="workflow-box workflow-box-phishing" x="550" y="445" width="400" height="150" rx="3"/>
  <rect fill="#e74c3c" x="550" y="445" width="400" height="20" rx="3"/>
  <text class="text-header" x="750" y="460" text-anchor="middle" font-size="10">SIMULATION WORKFLOW</text>
  <text class="text-normal" x="560" y="480" font-size="9">1. Profile Analysis (Vulnerabilities)</text>
  <text class="text-normal" x="560" y="495" font-size="9">2. Generate Email OR Quishing (QR)</text>
  <text class="text-normal" x="560" y="510" font-size="9">3. Generate Landing Page (Fake Login)</text>
  <text class="text-normal" x="560" y="525" font-size="9">4. Department Customization</text>
  <text class="text-normal" x="560" y="540" font-size="9">5. Brand Spoofing Check</text>

  <text fill="#9b59b6" font-size="9" x="550" y="660">ðŸ”— OpenAI | NIST CVE | Apistemic Logos</text>


  <!-- C. POLICY (Mid-Right) - NEW -->
  <rect class="box" x="1030" y="340" width="440" height="340" rx="5"/>
  <rect class="box-header-policy" x="1030" y="340" width="440" height="30" rx="5"/>
  <text class="text-header" x="1250" y="360" text-anchor="middle">Policy Summary Agent</text>
  <text fill="#8e44ad" font-weight="bold" x="1100" y="385" font-size="10">(RAG Expert | Compliance Q&amp;A)</text>

  <rect class="workflow-box workflow-box-policy" x="1050" y="445" width="400" height="150" rx="3"/>
  <rect fill="#8e44ad" x="1050" y="445" width="400" height="20" rx="3"/>
  <text class="text-header" x="1250" y="460" text-anchor="middle" font-size="10">POLICY RAG WORKFLOW</text>
  <text class="text-normal" x="1060" y="480" font-size="9">1. Detect Intent ("What is the policy?")</text>
  <text class="text-normal" x="1060" y="495" font-size="9">2. Embed Query (Workers AI)</text>
  <text class="text-normal" x="1060" y="510" font-size="9">3. Search Vector DB (D1)</text>
  <text class="text-normal" x="1060" y="525" font-size="9">4. Summarize Context</text>
  <text class="text-normal" x="1060" y="540" font-size="9">5. Format as HTML</text>


  <!-- D. USER INFO (Right) -->
  <rect class="box" x="1530" y="340" width="440" height="340" rx="5"/>
  <rect class="box-header-userinfo" x="1530" y="340" width="440" height="30" rx="5"/>
  <text class="text-header" x="1750" y="360" text-anchor="middle">User Info Agent</text>
  <text fill="#27ae60" font-weight="bold" x="1600" y="385" font-size="10">(Risk Analyst | Behavioral Profiling)</text>

  <rect class="workflow-box workflow-box-userinfo" x="1550" y="445" width="400" height="150" rx="3"/>
  <rect fill="#27ae60" x="1550" y="445" width="400" height="20" rx="3"/>
  <text class="text-header" x="1750" y="460" text-anchor="middle" font-size="10">RISK ANALYSIS WORKFLOW</text>
  <text class="text-normal" x="1560" y="480" font-size="9">1. Fetch User Timeline (API)</text>
  <text class="text-normal" x="1560" y="495" font-size="9">2. Calculate Risk Score</text>
  <text class="text-normal" x="1560" y="510" font-size="9">3. Detect Knowledge Gaps</text>
  <text class="text-normal" x="1560" y="525" font-size="9">4. Recommend Training Level</text>
  
  <text fill="#9b59b6" font-size="9" x="1550" y="660">ðŸ”— Fleet Backend API | Phishing History</text>


  <!-- ============================================== -->
  <!-- 3b. DIRECT API AGENTS (Right column - no crossing) -->
  <!-- ============================================== -->

  <!-- Separator: Main flow | Direct API flow -->
  <line x1="2000" y1="50" x2="2000" y2="720" stroke="#bdc3c7" stroke-width="1" stroke-dasharray="8,4" opacity="0.6"/>

  <!-- Arrows from Public APIs to Direct Agents (parallel, no overlap) -->
  <path class="arrow-colored" stroke="#16a085" marker-end="url(#arrowhead-smishing)" stroke-dasharray="6,4" d="M 2180 110 L 2180 340"/>
  <path class="arrow-colored" stroke="#2980b9" marker-end="url(#arrowhead-emailir)" stroke-dasharray="6,4" d="M 2325 110 L 2325 470"/>
  <path class="arrow-colored" stroke="#c0392b" marker-end="url(#arrowhead-vishing)" stroke-dasharray="6,4" d="M 2470 110 L 2470 600"/>

  <!-- Smishing Agent (right column) -->
  <rect class="box" x="2050" y="340" width="550" height="110" rx="5"/>
  <rect class="box-header-smishing" x="2050" y="340" width="550" height="25" rx="5"/>
  <text class="text-header" x="2325" y="358" text-anchor="middle">Smishing Agent (SMS Simulator)</text>
  <text fill="#16a085" font-weight="bold" x="2070" y="380" font-size="10">(SMS Templates | Link Placeholders | Department-aware)</text>
  <text class="text-normal" x="2070" y="400" font-size="9">/smishing/chat â†’ Generate SMS + Landing Page</text>
  <text fill="#9b59b6" font-size="9" x="2070" y="435">ðŸ”— OpenAI | Twilio (optional)</text>

  <!-- Email IR Analyst (right column) -->
  <rect class="box" x="2050" y="470" width="550" height="110" rx="5"/>
  <rect class="box-header-emailir" x="2050" y="470" width="550" height="25" rx="5"/>
  <text class="text-header" x="2325" y="488" text-anchor="middle">Email IR Analyst</text>
  <text fill="#2980b9" font-weight="bold" x="2070" y="510" font-size="10">(Triage | IR Report | Risk Level)</text>
  <text class="text-normal" x="2070" y="530" font-size="9">/email-ir/analyze â†’ Headers + Body Intent + Behavioral â†’ Report</text>
  <text fill="#9b59b6" font-size="9" x="2070" y="565">ðŸ”— OpenAI | KV</text>

  <!-- Vishing Call Agent (right column) -->
  <rect class="box" x="2050" y="600" width="550" height="110" rx="5"/>
  <rect class="box-header-vishing" x="2050" y="600" width="550" height="25" rx="5"/>
  <text class="text-header" x="2325" y="618" text-anchor="middle">Vishing Call Agent</text>
  <text fill="#c0392b" font-weight="bold" x="2070" y="640" font-size="10">(ElevenLabs Voice | Debrief Summary)</text>
  <text class="text-normal" x="2070" y="660" font-size="9">/vishing/prompt | /vishing/conversations/summary</text>
  <text fill="#9b59b6" font-size="9" x="2070" y="695">ðŸ”— ElevenLabs Conversational AI</text>


  <!-- ============================================== -->
  <!-- 4. WORKERS LAYER -->
  <!-- ============================================== -->
  
  <!-- crud-training-worker -->
  <rect class="box" x="100" y="750" width="300" height="100" rx="5"/>
  <rect class="box-header-worker" x="100" y="750" width="300" height="25" rx="5"/>
  <text class="text-header" x="250" y="768" text-anchor="middle">crud-training-worker</text>
  <text class="text-normal" x="110" y="790">â€¢ Assigns Training to LMS</text>
  <text class="text-normal" x="110" y="805">â€¢ Tracks Completion</text>
  <text class="text-normal" x="110" y="820">â€¢ Updates User Progress</text>

  <!-- crud-phishing-worker -->
  <rect class="box" x="600" y="750" width="300" height="100" rx="5"/>
  <rect class="box-header-worker" x="600" y="750" width="300" height="25" rx="5"/>
  <text class="text-header" x="750" y="768" text-anchor="middle">crud-phishing-worker</text>
  <text class="text-normal" x="610" y="790">â€¢ Deploys Campaigns</text>
  <text class="text-normal" x="610" y="805">â€¢ Tracks Clicks &amp; Reports</text>
  <text class="text-normal" x="610" y="820">â€¢ Updates Vulnerability</text>

  <!-- Connect Agents to Workers (vertical, clean) -->
  <path class="arrow-colored" stroke="#f39c12" marker-end="url(#arrowhead-worker)" d="M 250 680 L 250 750"/>
  <path class="arrow-colored" stroke="#f39c12" marker-end="url(#arrowhead-worker)" d="M 750 680 L 750 750"/>


  <!-- ============================================== -->
  <!-- 5. STORAGE LAYER (KV) -->
  <!-- ============================================== -->

  <rect class="box" x="400" y="900" width="1200" height="80" rx="5"/>
  <rect class="box-header" x="400" y="900" width="1200" height="25" rx="5"/>
  <text class="text-header" x="1000" y="917" text-anchor="middle">Cloudflare KV Storage (The Memory) + D1</text>
  
  <text class="text-normal" x="420" y="945" font-family="monospace">ml:{id}:base</text>
  <text class="text-normal" x="420" y="960" font-family="monospace">ml:{id}:lang:{code}</text>

  <text class="text-normal" x="620" y="945" font-family="monospace">ps:{id}:base</text>
  <text class="text-normal" x="620" y="960" font-family="monospace">ps:{id}:email</text>

  <text class="text-normal" x="820" y="945" font-family="monospace">autonomous:thread:{id}</text>
  <text class="text-normal" x="820" y="960" font-family="monospace">autonomous:policy:{id}</text>

  <!-- Converge Arrows to Storage (route around workers) -->
  <path class="arrow-colored" stroke="#3498db" marker-end="url(#arrowhead-ml)" d="M 250 680 L 80 680 L 80 880 L 500 900"/>
  <path class="arrow-colored" stroke="#e74c3c" marker-end="url(#arrowhead-phishing)" d="M 750 680 L 950 680 L 950 880 L 800 900"/>
  <path class="arrow-colored" stroke="#27ae60" marker-end="url(#arrowhead-userinfo)" d="M 1750 680 L 1750 880 L 1400 900"/>
  
  <!-- ============================================== -->
  <!-- 6. RESPONSE LAYER -->
  <!-- ============================================== -->

  <rect class="box" x="450" y="1020" width="1100" height="50" rx="5"/>
  <rect class="box-header" x="450" y="1020" width="1100" height="25" rx="5"/>
  <text class="text-header" x="1000" y="1037" text-anchor="middle">Return Response (Streamed)</text>
  <text class="text-normal" x="500" y="1060">Learning URL | Phishing/Smishing Links | Policy HTML | Risk Report | Vishing Summary | Email IR Report</text>
  
  <!-- Storage to Response -->
  <path class="arrow" d="M 1000 980 L 1000 1020"/>


  <!-- ============================================== -->
  <!-- LEGEND / FEATURES -->
  <!-- ============================================== -->
  
  <rect class="box" x="100" y="1110" width="2500" height="220" rx="5"/>
  <text x="120" y="1140" font-size="16" font-weight="bold" fill="#2c3e50" font-family="sans-serif">Key Features &amp; Capabilities:</text>

  <g transform="translate(120, 1170)">
    <text y="0"  class="text-normal">âœ“ Orchestrator: NLP-based intent analysis to route between 7 Specialist Agents.</text>
    <text y="20" class="text-normal">âœ“ Public APIs: /smishing/chat | /vishing/prompt | /vishing/conversations/summary | /email-ir/analyze (direct).</text>
    <text y="40" class="text-normal">âœ“ Middleware: AsyncLocalStorage, Rate Limiting, Auth.</text>
    <text y="60" class="text-normal">âœ“ 4-State Machine: Strict checks (Gather -> Summary -> Execute -> Complete) before generation.</text>
    <text y="80" class="text-normal">âœ“ Smishing: SMS templates + landing pages (department-aware).</text>
    <text y="100" class="text-normal">âœ“ Vishing: ElevenLabs voice calls with debrief summary.</text>
  </g>

  <g transform="translate(700, 1170)">
    <text y="0"  class="text-normal">âœ“ Email IR: Triage + IR report (headers, body intent, behavioral signals).</text>
    <text y="20" class="text-normal">âœ“ Phishing &amp; Quishing: Cialdini-based email + QR code attacks.</text>
    <text y="40" class="text-normal">âœ“ Policy Expert: RAG-based search over internal documents (D1).</text>
    <text y="60" class="text-normal">âœ“ Risk Profiling: Behavioral analysis to auto-assign training levels.</text>
    <text y="80" class="text-normal">âœ“ External Workers: Async LMS assignment &amp; campaign deployment.</text>
    <text y="100" class="text-normal">âœ“ Unlimited Languages: Auto-detection (BCP-47) &amp; Parallel Localization.</text>
  </g>

  <g transform="translate(1300, 1170)">
     <text y="0"  class="text-normal">âœ“ Cloudflare KV: Atomic writes with namespace isolation (ml:*, ps:*).</text>
     <text y="20" class="text-normal">âœ“ Autonomous Loop: Proactive cron job to 'heal' high-risk users.</text>
     <text y="40" class="text-normal">âœ“ Streamed Responses: Low TTFB architecture for instant feedback.</text>
     <text y="60" class="text-normal">âœ“ D1 Vector DB: Semantic search for video &amp; policy matching.</text>
     <text y="80" class="text-normal">âœ“ Brand Detection: Apistemic Logos API integration with text fallback.</text>
  </g>

</svg>
