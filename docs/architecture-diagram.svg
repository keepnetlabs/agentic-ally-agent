<svg viewBox="0 0 1500 1250" xmlns="http://www.w3.org/2000/svg">
  <!-- Define styles -->
  <defs>
    <style>
      .box { fill: #f0f4f8; stroke: #2c3e50; stroke-width: 2; }
      .box-header { fill: #34495e; }
      .box-header-ml { fill: #3498db; }
      .box-header-phishing { fill: #e74c3c; }
      .box-header-userinfo { fill: #27ae60; }
      .box-header-worker { fill: #f39c12; }
      .workflow-box-ml { fill: #f0f4f8; stroke: #3498db; stroke-width: 2; }
      .workflow-box-phishing { fill: #f0f4f8; stroke: #e74c3c; stroke-width: 2; }
      .workflow-box-userinfo { fill: #f0f4f8; stroke: #27ae60; stroke-width: 2; }
      .workflow-box-worker { fill: #fef9e7; stroke: #f39c12; stroke-width: 2; }
      .text-header { fill: white; font-size: 14px; font-weight: bold; }
      .text-normal { fill: #2c3e50; font-size: 12px; }
      .arrow { stroke: #34495e; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
      .arrow-label { fill: #34495e; font-size: 10px; font-weight: bold; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#34495e" />
    </marker>
    <marker id="arrowhead-ml" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#3498db" />
    </marker>
    <marker id="arrowhead-phishing" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#e74c3c" />
    </marker>
    <marker id="arrowhead-userinfo" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#27ae60" />
    </marker>
    <marker id="arrowhead-worker" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#f39c12" />
    </marker>
  </defs>

  <!-- Title -->
  <text x="750" y="30" font-size="24" font-weight="bold" text-anchor="middle" fill="#2c3e50">
    Agentic Ally - High-Level Architecture (v2)
  </text>

  <!-- 1. User Input -->
  <rect class="box" x="550" y="50" width="400" height="70" rx="5"/>
  <rect class="box-header" x="550" y="50" width="400" height="25" rx="5"/>
  <text class="text-header" x="750" y="67" text-anchor="middle">HTTP POST /chat</text>
  <text class="text-normal" x="570" y="90">â€¢ prompt: string</text>
  <text class="text-normal" x="570" y="105">â€¢ modelProvider?: OPENAI | WORKERS_AI</text>

  <!-- Arrow 1 -->
  <path class="arrow" d="M 750 120 L 750 145"/>

  <!-- Middleware Layer -->
  <rect class="box" x="450" y="145" width="600" height="70" rx="5"/>
  <rect class="box-header" x="450" y="145" width="600" height="25" rx="5"/>
  <text class="text-header" x="750" y="162" text-anchor="middle">Middleware Layer (Request Context)</text>
  <text class="text-normal" x="470" y="185">âœ“ AsyncLocalStorage context | âœ“ Auth token | âœ“ Rate limiting</text>

  <!-- Arrow 2 -->
  <path class="arrow" d="M 750 215 L 750 240"/>

  <!-- Orchestrator Agent -->
  <rect class="box" x="450" y="240" width="600" height="70" rx="5"/>
  <rect fill="#9b59b6" x="450" y="240" width="600" height="25" rx="5"/>
  <text class="text-header" x="750" y="257" text-anchor="middle">Orchestrator Agent (Router)</text>
  <text class="text-normal" x="470" y="280">Routes to: Microlearning | Phishing Email | User Info specialist agents</text>

  <!-- Arrow from Orchestrator - splits to 3 -->
  <path class="arrow" stroke="#3498db" marker-end="url(#arrowhead-ml)" d="M 600 310 L 250 350"/>
  <path class="arrow" stroke="#e74c3c" marker-end="url(#arrowhead-phishing)" d="M 750 310 L 750 350"/>
  <path class="arrow" stroke="#27ae60" marker-end="url(#arrowhead-userinfo)" d="M 900 310 L 1250 350"/>

  <!-- Labels for arrows -->
  <text x="380" y="325" class="arrow-label" fill="#3498db">Microlearning</text>
  <text x="770" y="335" class="arrow-label" fill="#e74c3c">Phishing</text>
  <text x="1050" y="325" class="arrow-label" fill="#27ae60">User Info</text>

  <!-- 2a. MICROLEARNING AGENT - LEFT -->
  <rect class="box" x="30" y="350" width="440" height="340" rx="5"/>
  <rect class="box-header-ml" x="30" y="350" width="440" height="30" rx="5"/>
  <text class="text-header" x="250" y="370" text-anchor="middle">Microlearning Agent</text>
  <text fill="#3498db" font-weight="bold" x="50" y="395" font-size="10">(4-State Machine | Gamification | Adaptive Learning)</text>

  <rect class="box" x="50" y="410" width="400" height="35" rx="3"/>
  <text class="text-normal" x="70" y="432" font-size="10">â†“ calls workflowExecutorTool (create-ml or add-language)</text>

  <!-- CREATE Workflow -->
  <rect class="workflow-box-ml" x="50" y="455" width="190" height="130" rx="3"/>
  <rect fill="#3498db" x="50" y="455" width="190" height="22" rx="3"/>
  <text class="text-header" x="145" y="471" text-anchor="middle" font-size="11">CREATE</text>
  <text class="text-normal" x="60" y="493" font-size="9">1. Analyze (lang detect, topic)</text>
  <text class="text-normal" x="60" y="508" font-size="9">2. Generate (8-scene metadata)</text>
  <text class="text-normal" x="60" y="523" font-size="9">3. [PARALLEL]</text>
  <text class="text-normal" x="65" y="538" font-size="9">â€¢ Lang Content</text>
  <text class="text-normal" x="65" y="553" font-size="9">â€¢ Inbox Simulation</text>
  <text class="text-normal" x="60" y="568" font-size="9">4. Upload to Worker</text>

  <!-- ADD-LANGUAGE Workflow -->
  <rect class="workflow-box-ml" x="260" y="455" width="190" height="130" rx="3"/>
  <rect fill="#3498db" x="260" y="455" width="190" height="22" rx="3"/>
  <text class="text-header" x="355" y="471" text-anchor="middle" font-size="11">ADD-LANG</text>
  <text class="text-normal" x="270" y="493" font-size="9">1. Load (Fetch from KV)</text>
  <text class="text-normal" x="270" y="508" font-size="9">2. Localize (3-level retry)</text>
  <text class="text-normal" x="270" y="523" font-size="9">3. Save</text>
  <text class="text-normal" x="275" y="538" font-size="9">â€¢ ml:{id}:lang</text>
  <text class="text-normal" x="275" y="553" font-size="9">â€¢ ml:{id}:inbox</text>

  <text fill="#9b59b6" font-size="9" x="50" y="610">ðŸ”— OpenAI/Workers AI | KV Storage</text>

  <!-- 2b. PHISHING AGENT - MIDDLE -->
  <rect class="box" x="530" y="350" width="440" height="340" rx="5"/>
  <rect class="box-header-phishing" x="530" y="350" width="440" height="30" rx="5"/>
  <text class="text-header" x="750" y="370" text-anchor="middle">Phishing Email Agent</text>
  <text fill="#e74c3c" font-weight="bold" x="550" y="395" font-size="10">(Cialdini Principles | Social Engineering | NIST CVE)</text>

  <rect class="box" x="550" y="410" width="400" height="35" rx="3"/>
  <text class="text-normal" x="570" y="432" font-size="10">â†“ calls phishingWorkflowExecutorTool</text>

  <!-- PHISHING Workflow -->
  <rect class="workflow-box-phishing" x="550" y="455" width="400" height="160" rx="3"/>
  <rect fill="#e74c3c" x="550" y="455" width="400" height="22" rx="3"/>
  <text class="text-header" x="750" y="471" text-anchor="middle" font-size="11">PHISHING SIMULATION</text>
  <text class="text-normal" x="560" y="493" font-size="9">1. Profile Analysis (vulnerabilities, triggers)</text>
  <text class="text-normal" x="560" y="510" font-size="9">2. Generate Simulation (Cialdini Principles)</text>
  <text class="text-normal" x="560" y="527" font-size="9">3. Edit (refine emails via phishing-editor)</text>
  <text class="text-normal" x="560" y="544" font-size="9">4. Save (ps:{id}:base, emails per user/dept)</text>
  <text class="text-normal" x="560" y="561" font-size="9">5. Upload &amp; Assign to Worker</text>
  <text class="text-normal" x="560" y="578" font-size="9">6. Generate Landing Pages (industry-aware)</text>

  <text fill="#9b59b6" font-size="9" x="550" y="640">ðŸ”— OpenAI | NIST CVE API | Apistemic Logos API</text>

  <!-- 2c. USER INFO AGENT - RIGHT -->
  <rect class="box" x="1030" y="350" width="440" height="340" rx="5"/>
  <rect class="box-header-userinfo" x="1030" y="350" width="440" height="30" rx="5"/>
  <text class="text-header" x="1250" y="370" text-anchor="middle">User Info Agent</text>
  <text fill="#27ae60" font-weight="bold" x="1050" y="395" font-size="10">(Risk Analyst | Behavioral Profiling | Timeline Analysis)</text>

  <rect class="box" x="1050" y="410" width="400" height="35" rx="3"/>
  <text class="text-normal" x="1070" y="432" font-size="10">No workflow - Analysis only (provides context)</text>

  <!-- RISK ANALYSIS -->
  <rect class="workflow-box-userinfo" x="1050" y="455" width="400" height="130" rx="3"/>
  <rect fill="#27ae60" x="1050" y="455" width="400" height="22" rx="3"/>
  <text class="text-header" x="1250" y="471" text-anchor="middle" font-size="11">RISK ANALYSIS</text>
  <text class="text-normal" x="1060" y="493" font-size="9">1. Fetch User Details (profile, history)</text>
  <text class="text-normal" x="1060" y="510" font-size="9">2. Analyze Timeline (vulnerability patterns)</text>
  <text class="text-normal" x="1060" y="527" font-size="9">3. Behavioral Scoring (click rates, report rates)</text>
  <text class="text-normal" x="1060" y="544" font-size="9">4. Recommend Level (Beginner/Intermediate/Advanced)</text>
  <text class="text-normal" x="1060" y="561" font-size="9">5. Generate Action Plan</text>

  <text fill="#9b59b6" font-size="9" x="1050" y="610">ðŸ”— OpenAI | Fleet Backend API | Phishing History</text>

  <!-- EXTERNAL WORKERS SECTION -->
  <rect class="workflow-box-worker" x="100" y="720" width="280" height="100" rx="5"/>
  <rect class="box-header-worker" x="100" y="720" width="280" height="25" rx="5"/>
  <text class="text-header" x="240" y="738" text-anchor="middle" font-size="11">crud-training-worker</text>
  <text class="text-normal" x="115" y="765" font-size="9">â€¢ Create/Update microlearning content</text>
  <text class="text-normal" x="115" y="782" font-size="9">â€¢ Assign training to users/groups</text>
  <text class="text-normal" x="115" y="799" font-size="9">â€¢ Track completion &amp; progress</text>

  <rect class="workflow-box-worker" x="610" y="720" width="280" height="100" rx="5"/>
  <rect class="box-header-worker" x="610" y="720" width="280" height="25" rx="5"/>
  <text class="text-header" x="750" y="738" text-anchor="middle" font-size="11">crud-phishing-worker</text>
  <text class="text-normal" x="625" y="765" font-size="9">â€¢ Create/Update phishing simulations</text>
  <text class="text-normal" x="625" y="782" font-size="9">â€¢ Deploy to users/departments</text>
  <text class="text-normal" x="625" y="799" font-size="9">â€¢ Collect click &amp; report analytics</text>

  <!-- Arrows from agents to workers -->
  <path class="arrow" stroke="#f39c12" marker-end="url(#arrowhead-worker)" d="M 250 690 L 250 720"/>
  <path class="arrow" stroke="#f39c12" marker-end="url(#arrowhead-worker)" d="M 750 690 L 750 720"/>

  <!-- Converge arrows to KV -->
  <path class="arrow" stroke="#3498db" marker-end="url(#arrowhead-ml)" d="M 240 820 L 500 870"/>
  <path class="arrow" stroke="#e74c3c" marker-end="url(#arrowhead-phishing)" d="M 750 820 L 750 870"/>
  <path class="arrow" stroke="#27ae60" marker-end="url(#arrowhead-userinfo)" d="M 1250 690 L 1000 870"/>

  <text x="340" y="850" class="arrow-label" fill="#3498db" font-size="9">ml:{id}</text>
  <text x="765" y="850" class="arrow-label" fill="#e74c3c" font-size="9">ps:{id}</text>
  <text x="1100" y="800" class="arrow-label" fill="#27ae60" font-size="9">context</text>

  <!-- 3. Common: Save to KV -->
  <rect class="box" x="400" y="870" width="700" height="70" rx="5"/>
  <rect class="box-header" x="400" y="870" width="700" height="25" rx="5"/>
  <text class="text-header" x="750" y="887" text-anchor="middle" font-size="12">3. Common: Save to KV (Fire-and-forget)</text>
  <text class="text-normal" x="420" y="915" font-size="10">Training: ml:{id}:base | Simulations: ps:{id}:base + per-dept, per-lang</text>

  <!-- Arrow down -->
  <path class="arrow" d="M 750 940 L 750 970"/>

  <!-- 4. Return Response -->
  <rect class="box" x="450" y="970" width="600" height="60" rx="5"/>
  <rect class="box-header" x="450" y="970" width="600" height="25" rx="5"/>
  <text class="text-header" x="750" y="987" text-anchor="middle" font-size="12">4. Return Response (Training URL or Simulation Link)</text>
  <text class="text-normal" x="470" y="1010" font-size="10">Ready-to-deploy microlearning URL | Phishing test link with analytics</text>

  <!-- Bottom legend -->
  <rect class="box" x="100" y="1060" width="1300" height="180" rx="5"/>
  <text x="120" y="1090" font-size="13" font-weight="bold" fill="#2c3e50">Key Features:</text>

  <text x="120" y="1115" font-size="11" fill="#2c3e50">âœ“ Orchestrator Router: Analyzes intent â†’ Routes to specialist agents</text>
  <text x="120" y="1135" font-size="11" fill="#2c3e50">âœ“ Middleware Layer: Context isolation (AsyncLocalStorage), rate limiting</text>
  <text x="120" y="1155" font-size="11" fill="#2c3e50">âœ“ 4-State Machine: Strict STATE 1â†’4 progression with confirmation gates</text>
  <text x="120" y="1175" font-size="11" fill="#2c3e50">âœ“ Unlimited Languages: Auto-detect via BCP-47 codes (en, tr, de, ja, etc.)</text>
  <text x="120" y="1195" font-size="11" fill="#2c3e50">âœ“ Parallel Execution: 8 scenes + Inbox generation run simultaneously</text>

  <text x="750" y="1115" font-size="11" fill="#2c3e50">âœ“ 3-Level Retry: Corruption detection, HTML tag protection, auto-fix</text>
  <text x="750" y="1135" font-size="11" fill="#2c3e50">âœ“ Phishing Workflow: Profile analysis â†’ Generate â†’ Upload &amp; Deploy (Cialdini)</text>
  <text x="750" y="1155" font-size="11" fill="#2c3e50">âœ“ KV Storage: ml:{id}:* + ps:{id}:* with per-dept, per-lang isolation</text>
  <text x="750" y="1175" font-size="11" fill="#2c3e50">âœ“ External Workers: crud-training-worker, crud-phishing-worker</text>
  <text x="750" y="1195" font-size="11" fill="#2c3e50">âœ“ Brand Detection: Apistemic Logos API with letter fallback</text>
</svg>
